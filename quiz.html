<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robust Flashcard Quiz App (Auto-Numbering)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background-color: #090216;
            color: #d5fbff;
        }
        h1 {
            text-align: center;
        }
        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #1a102e;
            color: #d5fbff;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px 10px 20px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            color: #aaa;
        }
        #options {
            text-align: center;
        }
        #quiz-area {
            display: none;
            margin-top: 40px;
            padding: 30px;
            background-color: #150a26;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            min-height: 300px;
        }
        #section-title {
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            color: #ffcc00;
            display: none;
        }
        #question {
            font-size: 24px;
            margin-bottom: 30px;
            line-height: 1.5;
            font-weight: bold;
        }
        #answer {
            font-size: 20px;
            color: #4ade80;
            display: none;
            margin-top: 30px;
            padding: 20px;
            background-color: #0f2e1b;
            border-left: 5px solid #28a745;
            border-radius: 4px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        #controls {
            text-align: center;
            margin-top: 40px;
            border-top: 1px solid #333;
            padding-top: 20px;
        }
        #progress {
            text-align: center;
            font-size: 18px;
            margin-top: 20px;
            color: #888;
        }
        .keyboard-hint {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Flashcard Quiz App</h1>
    
    <p>Paste your notes below. You can use numbered lists (1.), bullet points (*), or "Question:" prefixes. The app will organize them automatically.</p>
    
    <textarea id="input-text" placeholder="Paste your generated questions here..."></textarea>
    
    <div id="options">
        <button id="parse-btn">Start Quiz</button>
        <button id="random-toggle">Randomize: Off</button>
        <button id="reverse-toggle">Reverse Mode: Off</button>
        <button id="section-toggle">Show Sections: Off</button>
    </div>
    
    <div id="quiz-area">
        <div id="section-title"></div>
        <div id="question"></div>
        <div id="answer"></div>
        
        <div id="controls">
            <button id="prev-btn">Previous</button>
            <button id="reveal-btn">Show Answer</button>
            <button id="next-btn">Next</button>
        </div>
        
        <div id="progress"></div>
        
        <div class="keyboard-hint">
            Keyboard shortcuts: <strong>N</strong> / → = Next, <strong>P</strong> / ← = Previous, <strong>A</strong> / <strong>Space</strong> / <strong>Enter</strong> = Show/Hide Answer
        </div>
    </div>
    <script>
        let questions = [];
        let masterQuestions = [];
        let currentIndex = 0;
        let answerVisible = false;
        let randomized = false;
        let reversed = false;
        let showSections = false;

        const textarea = document.getElementById('input-text');
        const parseBtn = document.getElementById('parse-btn');
        const randomToggle = document.getElementById('random-toggle');
        const reverseToggle = document.getElementById('reverse-toggle');
        const sectionToggle = document.getElementById('section-toggle');
        const quizArea = document.getElementById('quiz-area');
        const sectionTitle = document.getElementById('section-title');
        const questionEl = document.getElementById('question');
        const answerEl = document.getElementById('answer');
        const prevBtn = document.getElementById('prev-btn');
        const revealBtn = document.getElementById('reveal-btn');
        const nextBtn = document.getElementById('next-btn');
        const progressEl = document.getElementById('progress');

        function shuffle(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function applySettings() {
            if (randomized) {
                questions = shuffle(masterQuestions.slice());
            } else {
                questions = masterQuestions.slice();
            }
            currentIndex = 0;
            answerVisible = false;
            answerEl.style.display = 'none';
            showQuestion();
        }

        function updateRevealBtn() {
            const term = reversed ? 'Question' : 'Answer';
            revealBtn.textContent = answerVisible ? `Hide ${term}` : `Show ${term}`;
            revealBtn.style.backgroundColor = answerVisible ? '#dc3545' : '#007bff';
        }

        function cleanAnswer(buffer) {
            if (buffer.length === 0) return '';
            let text = buffer.join('\n');
            text = text.replace(/^\s*(Answer|Ans)[:\-\s]*/i, '');
            return text.trim();
        }

        // --- NEW: Helper function to auto-number text ---
        function autoNumberText(rawText) {
            let counter = 1;
            // Matches "Question: " OR a line starting with "*"
            // The 'gm' flag (Global Multiline) handles the anchors correctly
            return rawText.replace(/(Question:\s)|(^\s*\*\s)/gm, (match) => {
                if (match.includes("Question:")) {
                    return `${counter++}. ${match}`;
                }
                return `${counter++}. `;
            });
        }

        function parseInput() {
            let text = textarea.value.trim();
            if (!text) {
                alert('Please paste some content first.');
                return;
            }

            // 1. RUN AUTO-NUMBERING ALGORITHM BEFORE PARSING
            text = autoNumberText(text);
            
            // 2. Update textarea so user sees the change (optional, but good UX)
            textarea.value = text;

            questions = [];
            let currentQ = null;
            let currentABuffer = [];
            let currentSection = '';

            const lines = text.split('\n');
            const numberRegex = /^\s*(\d+)\s*[\.\)\-\s]*\s*(.*)$/;

            lines.forEach(line => {
                const trimmed = line.trim();

                // Skip completely empty lines unless we're in an answer block
                if (trimmed === '' && !currentQ) {
                    return;
                }

                const numMatch = line.match(numberRegex);

                if (numMatch) {
                    // Numbered question found
                    if (currentQ) {
                        questions.push({
                            question: currentQ.trim(),
                            answer: cleanAnswer(currentABuffer),
                            section: currentSection
                        });
                        currentABuffer = [];
                    }

                    let content = numMatch[2];

                    // Look for inline answer after first "?"
                    const qMarkIndex = content.indexOf('?');
                    let questionText = content.trim();
                    let immediateAnswer = '';

                    if (qMarkIndex !== -1) {
                        const before = content.substring(0, qMarkIndex + 1);
                        const after = content.substring(qMarkIndex + 1).trimStart();
                        if (after) {
                            questionText = before.trim();
                            immediateAnswer = after;
                        }
                    }

                    currentQ = questionText;
                    if (immediateAnswer) {
                        currentABuffer.push(immediateAnswer);
                    }
                } else {
                    // Not numbered
                    if (currentQ) {
                        // Continue answer
                        currentABuffer.push(line);
                    } else {
                        // Possible section header or unnumbered question
                        if (trimmed.endsWith('?')) {
                            // Treat as unnumbered question
                            let content = line;
                            const qMarkIndex = content.indexOf('?');
                            let questionText = trimmed;
                            let immediateAnswer = '';

                            if (qMarkIndex !== -1 && qMarkIndex < content.length - 1) {
                                questionText = content.substring(0, qMarkIndex + 1).trim();
                                immediateAnswer = content.substring(qMarkIndex + 1).trimStart();
                            }

                            currentQ = questionText;
                            if (immediateAnswer) {
                                currentABuffer.push(immediateAnswer);
                            }
                        } else if (trimmed && !trimmed.startsWith('---') && !trimmed.startsWith('___') && !trimmed.startsWith('***')) {
                            // Assume section header
                            currentSection = trimmed;
                        }
                        // Else ignore (separator or junk)
                    }
                }
            });

            // Push final card
            if (currentQ) {
                questions.push({
                    question: currentQ.trim(),
                    answer: cleanAnswer(currentABuffer),
                    section: currentSection
                });
            }

            if (questions.length === 0) {
                alert('No questions detected. Try using numbered lists, bullet points (*), or lines ending in "?"');
                return;
            }

            masterQuestions = questions.slice();

            // Reset toggles for new quiz
            randomized = false;
            reversed = false;
            showSections = false;
            randomToggle.textContent = 'Randomize: Off';
            reverseToggle.textContent = 'Reverse Mode: Off';
            sectionToggle.textContent = 'Show Sections: Off';

            applySettings();
            quizArea.style.display = 'block';
            quizArea.scrollIntoView({ behavior: 'smooth' });
        }

        function showQuestion() {
            if (questions.length === 0) return;

            const q = questions[currentIndex];

            const displayQ = reversed ? q.answer : q.question;
            const displayA = reversed ? q.question : q.answer;

            questionEl.textContent = `${currentIndex + 1}. ${displayQ}`;
            answerEl.innerText = displayA || '(No answer)';

            // Section handling
            if (showSections && q.section) {
                sectionTitle.textContent = q.section;
                sectionTitle.style.display = 'block';
            } else {
                sectionTitle.style.display = 'none';
            }

            answerEl.style.display = 'none';
            answerVisible = false;
            updateRevealBtn();

            progressEl.textContent = `Card ${currentIndex + 1} of ${questions.length}`;

            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === questions.length - 1;
        }

        function revealAnswer() {
            answerVisible = !answerVisible;
            answerEl.style.display = answerVisible ? 'block' : 'none';
            updateRevealBtn();
        }

        function nextQuestion() {
            if (currentIndex < questions.length - 1) {
                currentIndex++;
                showQuestion();
            }
        }

        function prevQuestion() {
            if (currentIndex > 0) {
                currentIndex--;
                showQuestion();
            }
        }

        // Event listeners
        parseBtn.addEventListener('click', parseInput);

        randomToggle.addEventListener('click', () => {
            randomized = !randomized;
            randomToggle.textContent = `Randomize: ${randomized ? 'On' : 'Off'}`;
            applySettings();
        });

        reverseToggle.addEventListener('click', () => {
            reversed = !reversed;
            reverseToggle.textContent = `Reverse Mode: ${reversed ? 'On' : 'Off'}`;
            showQuestion();
        });

        sectionToggle.addEventListener('click', () => {
            showSections = !showSections;
            sectionToggle.textContent = `Show Sections: ${showSections ? 'On' : 'Off'}`;
            showQuestion();
        });

        prevBtn.addEventListener('click', prevQuestion);
        nextBtn.addEventListener('click', nextQuestion);
        revealBtn.addEventListener('click', revealAnswer);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (quizArea.style.display === 'none') return;
            if (document.activeElement === textarea) return;

            if (e.key === 'n' || e.key === 'N' || e.key === 'ArrowRight') {
                e.preventDefault();
                nextQuestion();
            } else if (e.key === 'p' || e.key === 'P' || e.key === 'ArrowLeft') {
                e.preventDefault();
                prevQuestion();
            } else if (e.key === 'a' || e.key === 'A' || e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                revealAnswer();
            }
        });
    </script>
</body>
</html>
